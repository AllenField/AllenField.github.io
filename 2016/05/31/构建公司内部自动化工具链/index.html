<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 构建公司内部自动化工具链 · 浮白</title><meta name="description" content="构建公司内部自动化工具链 - 浮白"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="https://github.com/AllenField/" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">构建公司内部自动化工具链</h1><div class="post-info">2016年05月31日</div><div class="post-content"><img src="/images/transfer.png">
<a id="more"></a>
<style type="text/css">.h1{font-weight:bold;font-size:24px;}.h2{font-weight:bold;font-size:22px;}.h3{font-weight:bold;font-size:20px;}.h4{font-weight:bold;font-size:18px;}.h5{font-weight:bold;font-size:16px;}.h6{font-weight:bold;font-size:14px;}
</style>

<p>我们要在内网安装GitLab，Nexus3和Jenkins。通过Docker把所有软件安装到一台主机上，假设这台主机的内网IP为192.168.0.55。首先要确保这台机器上安装了Docker和Git。</p>
<div class="h2">使用Docker安装Mysql</div>

<p><a href="https://github.com/sameersbn/docker-mysql" target="_blank" rel="external">GitHub -&gt; sameersbn/docker-mysql</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker pull sameersbn/mysql:latest</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/docker-volume/gitlab/mysql</span><br><span class="line"></span><br><span class="line">docker run -tid --name=gitlab_mysql \</span><br><span class="line">    -p 3306:3306 \</span><br><span class="line">    -e &apos;DB_NAME=demo&apos; \</span><br><span class="line">    -e &apos;DB_USER=fubai&apos; \</span><br><span class="line">    -e &apos;DB_PASS=123456&apos; \</span><br><span class="line">    -v /usr/docker-volume/gitlab/mysql:/var/lib/mysql \</span><br><span class="line">    sameersbn/mysql:latest</span><br><span class="line"></span><br><span class="line">docker logs gitlab_mysql</span><br></pre></td></tr></table></figure>
<div class="h2">使用Docker安装Redis</div>

<p><a href="https://github.com/sameersbn/docker-redis" target="_blank" rel="external">GitHub -&gt; sameersbn/docker-redis</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker pull sameersbn/redis:latest</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/docker-volume/gitlab/redis</span><br><span class="line"></span><br><span class="line">docker run -tid --name=gitlab_redis \</span><br><span class="line">    --restart=always \</span><br><span class="line">    -p 6379:6379 \</span><br><span class="line">    -v /usr/docker-volume/gitlab/redis:/var/lib/redis \</span><br><span class="line">    sameersbn/redis:latest</span><br><span class="line"></span><br><span class="line">docker logs gitlab_redis</span><br></pre></td></tr></table></figure>
<div class="h2">使用Docker安装GitLab</div>

<p><a href="https://github.com/sameersbn/docker-gitlab" target="_blank" rel="external">GitHub -&gt; sameersbn/docker-gitlab</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">docker pull sameersbn/gitlab:8.7.6</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/docker-volume/gitlab/data /usr/docker-volume/gitlab/backup /usr/docker-volume/gitlab/log</span><br><span class="line"></span><br><span class="line">docker run -tid --name=&apos;gitlab&apos; \</span><br><span class="line">    --link gitlab_mysql:mysql \</span><br><span class="line">    --link gitlab_redis:redisio \</span><br><span class="line">    -e &apos;GITLAB_PORT=80&apos; \</span><br><span class="line">    -e &apos;GITLAB_SSH_PORT=22&apos; \</span><br><span class="line">    -e &apos;GITLAB_HOST=192.168.0.55&apos; \</span><br><span class="line">    -e &apos;SMTP_ENABLED=true&apos; \</span><br><span class="line">    -e &apos;SMTP_DOMAIN=www.qq.com&apos; \</span><br><span class="line">    -e &apos;SMTP_HOST=smtp.exmail.qq.com&apos; \</span><br><span class="line">    -e &apos;SMTP_PORT=25&apos; \</span><br><span class="line">    -e &apos;SMTP_STARTTLS=false&apos; \</span><br><span class="line">    -e &apos;SMTP_USER=SMTP邮箱&apos; \</span><br><span class="line">    -e &apos;SMTP_PASS=SMTP密码&apos; \</span><br><span class="line">    -e &apos;SMTP_AUTHENTICATION=login&apos; \</span><br><span class="line">    -e &apos;GITLAB_BACKUP_DIR=/usr/docker-volume/gitlab/backup&apos; \</span><br><span class="line">    -e &apos;GITLAB_BACKUP_SCHEDULE=weekly&apos; \</span><br><span class="line">    -e &apos;GITLAB_BACKUP_EXPIRY=604800&apos; \</span><br><span class="line">    -e &apos;GITLAB_SECRETS_DB_KEY_BASE=64位随机字符串&apos; \</span><br><span class="line">    -p 80:80 \</span><br><span class="line">    -p 22:22 \</span><br><span class="line">    -v /var/run/docker.sock:/run/docker.sock \</span><br><span class="line">    -v $(which docker):/bin/docker \</span><br><span class="line">    -v /usr/docker-volume/gitlab/data:/home/git/data \</span><br><span class="line">    -v /usr/docker-volume/gitlab/log:/var/log/gitlab \</span><br><span class="line">    sameersbn/gitlab:8.7.6</span><br><span class="line"></span><br><span class="line">docker logs gitlab</span><br></pre></td></tr></table></figure>
<p>运行GitLab的Docker镜像时，将远程主机的<code>80</code>和<code>22</code>端口转发到了Docker上，所以要保证远程主机的80和22端口未被占用，如果远程主机的sshd在使用22端口，将其修改成其它的端口。</p>
<p>假设要将远程主机的sshd端口号修改为10022，需要将<code>/etc/ssh/sshd_config</code>的<code>Port</code>修改为<code>10022</code>，然后重启sshd: <code>service ssh restart</code>。</p>
<p>远程登录可以使用<code>ssh -p 10022 用户名@主机ip</code>，远程拷贝可以使用: <code>scp -P 10022 本地文件 用户名@远程主机IP:远程主机目录</code>。</p>
<p>64位随机字符串的生成可以使用: <code>pwgen -Bsv1 64</code></p>
<div class="h2">使用Docker安装Nexus3</div>

<p><a href="https://github.com/sonatype/docker-nexus3" target="_blank" rel="external">GitHub -&gt; sonatype/docker-nexus3</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker pull sonatype/nexus3</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/docker-volume/nexus-data</span><br><span class="line"></span><br><span class="line">chown -R 200 /usr/docker-volume/nexus-data</span><br><span class="line"></span><br><span class="line">docker run -tid --name=nexus \</span><br><span class="line">    --privileged=true \</span><br><span class="line">    -p 8081:8081 \</span><br><span class="line">    -v /usr/docker-volume/nexus-data:/nexus-data \</span><br><span class="line">    sonatype/nexus3</span><br><span class="line"></span><br><span class="line">docker logs nexus</span><br></pre></td></tr></table></figure>
<p>安装Nexus3时，需要将数据卷的<code>uid</code>修改为Docker容器中<code>nexus用户的uid</code>，这个uid可以在对应的Dockfile中找到。</p>
<p>如果不修改，那么改数据卷的所属用户为<code>root</code>，Nexus3运行时，其运行用户<code>nexus将没有权限修改数据卷中的内容</code>，导致Nexus3无法正常运行。</p>
<div class="h2">使用Docker安装Jenkins</div>

<p><a href="https://github.com/jenkinsci/docker" target="_blank" rel="external">GitHub -&gt; jenkinsci/docker</a></p>
<div class="h3">构建Docker镜像</div>

<div class="h4">下载相关文件</div>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/jenkinsci/docker.git</span><br></pre></td></tr></table></figure>
<p>下载<a href="http://mirror.bit.edu.cn/apache/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz" target="_blank" rel="external">apache-maven-3.3.9-bin.tar.gz</a>，并移动到jenkinsci/docker文件夹内</p>
<p>下载<a href="https://github.com/krallin/tini/releases/download/v0.5.0/tini-static" target="_blank" rel="external">tini-static</a>（需要翻墙），并移动到jenkinsci/docker文件夹内，修改其名称为tini</p>
<div class="h4">在jenkinsci/docker文件夹下添加settings.xml</div>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;settings xmlns=&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;</span><br><span class="line">          xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">          xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;&gt;</span><br><span class="line">  &lt;localRepository&gt;/var/jenkins_home/.m2/repository&lt;/localRepository&gt;</span><br><span class="line"></span><br><span class="line">  &lt;pluginGroups&gt;</span><br><span class="line">  &lt;/pluginGroups&gt;</span><br><span class="line"></span><br><span class="line">  &lt;proxies&gt;</span><br><span class="line">  &lt;/proxies&gt;</span><br><span class="line"></span><br><span class="line">  &lt;servers&gt;</span><br><span class="line">    &lt;server&gt;</span><br><span class="line">      &lt;id&gt;maven-releases&lt;/id&gt;</span><br><span class="line">      &lt;username&gt;Nexus用户名&lt;/username&gt;</span><br><span class="line">      &lt;password&gt;密码&lt;/password&gt;</span><br><span class="line">    &lt;/server&gt;</span><br><span class="line">    &lt;server&gt;</span><br><span class="line">      &lt;id&gt;maven-snapshots&lt;/id&gt;</span><br><span class="line">      &lt;username&gt;Nexus用户名&lt;/username&gt;</span><br><span class="line">      &lt;password&gt;密码&lt;/password&gt;</span><br><span class="line">    &lt;/server&gt;</span><br><span class="line">  &lt;/servers&gt;</span><br><span class="line"></span><br><span class="line">  &lt;mirrors&gt;</span><br><span class="line">    &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">      &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">      &lt;name&gt;mirrorOfAll&lt;/name&gt;</span><br><span class="line">      &lt;url&gt;http://192.168.0.55:8081/repository/maven-public/&lt;/url&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line">  &lt;/mirrors&gt;</span><br><span class="line"></span><br><span class="line">  &lt;profiles&gt;</span><br><span class="line">    &lt;profile&gt;</span><br><span class="line">      &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">      &lt;repositories&gt;</span><br><span class="line">        &lt;repository&gt;</span><br><span class="line">          &lt;id&gt;central&lt;/id&gt;</span><br><span class="line">          &lt;url&gt;http://central&lt;/url&gt;</span><br><span class="line">          &lt;releases&gt;</span><br><span class="line">            &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">          &lt;/releases&gt;</span><br><span class="line">          &lt;snapshots&gt;</span><br><span class="line">            &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">          &lt;/snapshots&gt;</span><br><span class="line">        &lt;/repository&gt;</span><br><span class="line">      &lt;/repositories&gt;</span><br><span class="line">      &lt;pluginRepositories&gt;</span><br><span class="line">        &lt;pluginRepository&gt;</span><br><span class="line">          &lt;id&gt;central&lt;/id&gt;</span><br><span class="line">          &lt;url&gt;http://central&lt;/url&gt;</span><br><span class="line">          &lt;releases&gt;</span><br><span class="line">            &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">          &lt;/releases&gt;</span><br><span class="line">          &lt;snapshots&gt;</span><br><span class="line">            &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">          &lt;/snapshots&gt;</span><br><span class="line">        &lt;/pluginRepository&gt;</span><br><span class="line">      &lt;/pluginRepositories&gt;</span><br><span class="line">    &lt;/profile&gt;</span><br><span class="line">  &lt;/profiles&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;activeProfiles&gt;</span><br><span class="line">    &lt;activeProfile&gt;nexus&lt;/activeProfile&gt;</span><br><span class="line">  &lt;/activeProfiles&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>
<div class="h4">修改Dockerfile</div>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">FROM java:8-jdk</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y git curl zip &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line">ENV JENKINS_HOME /var/jenkins_home</span><br><span class="line">ENV JENKINS_SLAVE_AGENT_PORT 50000</span><br><span class="line"></span><br><span class="line">ARG user=jenkins</span><br><span class="line">ARG group=jenkins</span><br><span class="line">ARG uid=1000</span><br><span class="line">ARG gid=1000</span><br><span class="line"></span><br><span class="line"># Jenkins is run with user `jenkins`, uid = 1000</span><br><span class="line"># If you bind mount a volume from the host or a data container, </span><br><span class="line"># ensure you use the same uid</span><br><span class="line">RUN groupadd -g $&#123;gid&#125; $&#123;group&#125; \</span><br><span class="line">    &amp;&amp; useradd -d &quot;$JENKINS_HOME&quot; -u $&#123;uid&#125; -g $&#123;gid&#125; -m -s /bin/bash $&#123;user&#125;</span><br><span class="line"></span><br><span class="line"># Jenkins home directory is a volume, so configuration and build history </span><br><span class="line"># can be persisted and survive image upgrades</span><br><span class="line">VOLUME /var/jenkins_home</span><br><span class="line"></span><br><span class="line"># `/usr/share/jenkins/ref/` contains all reference configuration we want </span><br><span class="line"># to set on a fresh new installation. Use it to bundle additional plugins </span><br><span class="line"># or config file with your custom jenkins Docker image.</span><br><span class="line">RUN mkdir -p /usr/share/jenkins/ref/init.groovy.d</span><br><span class="line"></span><br><span class="line">ENV TINI_SHA 066ad710107dc7ee05d3aa6e4974f01dc98f3888</span><br><span class="line"></span><br><span class="line"># Use tini as subreaper in Docker container to adopt zombie processes </span><br><span class="line">COPY tini /bin／tini</span><br><span class="line">RUN chmod +x /bin/tini \</span><br><span class="line">  &amp;&amp; echo &quot;$TINI_SHA  /bin/tini&quot; | sha1sum -c -</span><br><span class="line"></span><br><span class="line">COPY init.groovy /usr/share/jenkins/ref/init.groovy.d/tcp-slave-agent-port.groovy</span><br><span class="line"></span><br><span class="line">ARG JENKINS_VERSION</span><br><span class="line">ENV JENKINS_VERSION $&#123;JENKINS_VERSION:-1.651.2&#125;</span><br><span class="line">ARG JENKINS_SHA</span><br><span class="line">ENV JENKINS_SHA $&#123;JENKINS_SHA:-f61b8b604acba5076a93dcde28c0be2561d17bde&#125;</span><br><span class="line"></span><br><span class="line"># could use ADD but this one does not check Last-Modified header </span><br><span class="line"># see https://github.com/docker/docker/issues/8331</span><br><span class="line">RUN curl -fsSL http://repo.jenkins-ci.org/public/org/jenkins-ci/main/jenkins-war/$&#123;JENKINS_VERSION&#125;/jenkins-war-$&#123;JENKINS_VERSION&#125;.war -o /usr/share/jenkins/jenkins.war \</span><br><span class="line">  &amp;&amp; echo &quot;$JENKINS_SHA  /usr/share/jenkins/jenkins.war&quot; | sha1sum -c -</span><br><span class="line"></span><br><span class="line">ENV JENKINS_UC https://updates.jenkins.io</span><br><span class="line">RUN chown -R $&#123;user&#125; &quot;$JENKINS_HOME&quot; /usr/share/jenkins/ref</span><br><span class="line"></span><br><span class="line">ADD ./apache-maven-3.3.9-bin.tar.gz /usr/local/lib</span><br><span class="line"></span><br><span class="line">ENV M2_HOME /usr/local/lib/apache-maven-3.3.9</span><br><span class="line"></span><br><span class="line">RUN ln -s /usr/local/lib/apache-maven-3.3.9/bin/mvn /usr/bin/mvn &amp;&amp; mkdir -p $JENKINS_HOME/.m2</span><br><span class="line"></span><br><span class="line">COPY settings.xml $JENKINS_HOME/.m2/settings.xml</span><br><span class="line"></span><br><span class="line"># for main web interface:</span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line"># will be used by attached slave agents:</span><br><span class="line">EXPOSE 50000</span><br><span class="line"></span><br><span class="line">ENV COPY_REFERENCE_FILE_LOG $JENKINS_HOME/copy_reference_file.log</span><br><span class="line"></span><br><span class="line">USER $&#123;user&#125;</span><br><span class="line"></span><br><span class="line">COPY jenkins.sh /usr/local/bin/jenkins.sh</span><br><span class="line">ENTRYPOINT [&quot;/bin/tini&quot;, &quot;--&quot;, &quot;/usr/local/bin/jenkins.sh&quot;]</span><br><span class="line"></span><br><span class="line"># from a derived Dockerfile, can use `RUN plugins.sh active.txt` to setup /usr/share/jenkins/ref/plugins from a support bundle</span><br><span class="line">COPY plugins.sh /usr/local/bin/plugins.sh</span><br></pre></td></tr></table></figure>
<div class="h4">构建镜像</div>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t jenkins-maven .</span><br></pre></td></tr></table></figure>
<div class="h3">运行Jenkins</div>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/docker-volume/jenkins</span><br><span class="line"></span><br><span class="line">chown -R 1000 /usr/docker-volume/jenkins</span><br><span class="line"></span><br><span class="line">docker run -tid --name=jenkins \</span><br><span class="line">    --privileged=true \</span><br><span class="line">    -p 8082:8080 \</span><br><span class="line">    -p 50000:50000 \</span><br><span class="line">    -v /usr/docker-volume/jenkins:/var/jenkins_home jenkins-maven</span><br></pre></td></tr></table></figure>
<div class="h2">将GitLab上指定的项目关联到Slack指定的频道中</div>

<div class="h3">添加Slack的Webhook</div>

<ul>
<li><p>首先要为<code>channel</code>(<code>Slack</code>-&gt;<code>team</code>-&gt;<code>channel</code>)创建<code>webhooks</code>，Slack会给你一个webhooks的<code>url</code>，不同team的创建地址都不同，需要你自己找到自己team的webhooks的创建地址。</p>
</li>
<li><p>以管理员帐号登陆GitLab，然后是：某项目 -&gt; <code>Settings</code> -&gt; <code>Services</code> -&gt; <code>Slack</code>，现在进入到了GitLab上的指定项目的Slack设置页面，选中<code>Active</code>，将上一步的到的url输入到<code>Webhook</code>中，点击<code>Save changes</code>。</p>
</li>
</ul>
<p>Slack的webhook可以被GitLab调用。在code，wiki和issue等发生变化时，GibLab将特定的信息发送到对应的webhook上，然后Slack会将其发送到指定的频道中，如下图:</p>
<img src="/images/snapshot.png">
<div class="h2">配置Jenkins</div>

<div class="h3">安全配置</div>

<p>系统管理 -&gt; Configure Global Security，配置为下图：<br><img src="/images/s1.png"></p>
<p><code>保存</code>之后，页面右上角出现<code>注册</code>链接，点击进入后注册一个用户，然后进行下图的配置：</p>
<img src="/images/s2.png">
<p>先在<code>添加 用户/组:</code>中<code>添加</code>刚刚注册的用户，然后作出如图所示的配置，保存后就可以了。</p>
<p>上述配置是关闭Jenkins的匿名用户访问，并取消用户注册功能，建立了一个用户帐号<code>jenkins</code>，只有该用户可以登陆Jenkins。</p>
<div class="h3">安装插件</div>

<p>在可用插件中选择<code>Deploy to container Plugin</code>，<code>Git client plugin</code>，<code>Git plugin</code>，<code>GitLab Plugin</code>后安装</p>
<div class="h3">系统设置</div>

<div class="h4">JDK 设置</div>

<img src="/images/jdk-setting.png">
<div class="h4">Maven 设置</div>

<img src="/images/maven-setting.png">
<div class="h4">Git 设置</div>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 查看容器id</span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line">2. 进入容器</span><br><span class="line">docker exec -it &lt;容器id&gt; /bin/sh</span><br><span class="line"></span><br><span class="line">3. 为Git配置用户名密码</span><br><span class="line">git config --global user.email &quot;xxx@xxx.com&quot;</span><br><span class="line">git config --global user.name &quot;xxx&quot;</span><br><span class="line"></span><br><span class="line">4. 生成SSH key</span><br><span class="line">ssh-keygen -t rsa -C &quot;xxx@xxx.com&quot;</span><br><span class="line"></span><br><span class="line">5. 将SSH key生成的公钥添加到GitLab中，这里先要在GitLab中注册一个帐号。GitLab提供了deploy key的方式来为CI服务器提供Git服务，但是我这里并没有采用。</span><br></pre></td></tr></table></figure>
<div class="h4">GitLab 设置</div>

<img src="/images/gitlab-setting.png">
<div class="h2">创建Jenkins Task</div>

<div class="h3">构建一个maven项目</div>

<p>在上面构建Jenkins的Docker镜像时，我们已经为Jenkins安装并配置了Maven，所以可以不需要再为一个maven deploy操作配置nexus3私服的信息，下面开始配置：</p>
<p>先进入源码管理选项，选择Git，然后在<code>Credentials</code>处点击<code>Add</code>，进行如下图的设置：</p>
<img src="/images/task0.png">
<p>然后进行如下几张图的设置：</p>
<ul>
<li><p>图一:</p>
  <img src="/images/task1.png">
</li>
<li><p>图二:</p>
  <img src="/images/task2.png">
</li>
<li><p>图三:</p>
  <img src="/images/task3.png">
</li>
<li><p>图四:</p>
  <img src="/images/task4.png">
</li>
<li><p>图五:</p>
  <img src="/images/task5.png">
</li>
<li><p>图六:</p>
  <img src="/images/task6.png">
</li>
</ul>
<p><div class="h2">总结</div><br>通过创建Jenkins任务可以看到，Jenkins会使用Git从GitLab上拉取<code>demo-api</code>，然后通过Maven将其打包发布到Nexus中。最后使用将打包生成的war文件发布到Tomcat中去。</p>
<p>这个Jenkins任务的触发条件是GitLab，在<code>图三</code>中可以看到有一个<code>GitLab CI Service URL</code>，这个url就是这个Jenkins任务的<code>web hook</code>，需要将其拷贝粘贴到GitLab对应项目的<code>web hook</code>中，即图六所示。</p>
<p>这里的<code>demo-api</code>是我创建的一个Maven项目，对外提供了几个简单的REST API接口。通过Git将其push到GitLab上之后，在GitLab上创建该项目REST API对应的WIKI说明。</p>
<p>假设有两个开发人员<code>A</code>和<code>B</code>，A是后端开发人员，B是前端开发人员。A和B都在同一个Slack的频道中，而且，该频道的web hook在GibLab上被绑定到了A开发的后端项目上。现在，A修改了后台的Rest API，测试通过后，在GitLab上修改该API对应的WIKI说明。对WIKI的修改会向Slack频道中发送一条消息，那么，B现在就知道了A修改了API。然后A将代码提交到GitLab中，GitLab会调用Slack的web hook，将本次提交的相关信息发送到Slack的频道中。于是，B又收到了A确切提交的相关信息。与此同时，GitLab调用Jenkins的web hook，触发Jenkins任务。Jenkins使用Maven将后端项目编译打包后，部署到Tomcat中。那么B就能访问最新的API了。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/04/29/怎么写chaincode/" class="next">NEXT</a></div><div class="copyright"><p>种一棵树最好的时间是十年前，其次是现在</p><p>© 2016 <a href="http://fubai.tech">浮白</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-77150972-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?27c1fdf8e81dbebc08f420b1ef5888a6";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></body></html>